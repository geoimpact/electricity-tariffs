<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electricity Tariffs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Chart size styling */
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto py-8">
    <h1 class="text-3xl font-bold text-center mb-8">Electricity Tariffs</h1>

    <!-- Filter controls -->
    <div class="mb-8">
      <label for="productFilter" class="block text-lg font-semibold mb-2">Filter by Product:</label>
      <select id="productFilter" class="block w-full p-2 border border-gray-300 rounded-lg">
        <option value="all">All Products</option>
      </select>

      <label for="offerFilter" class="block text-lg font-semibold mt-4 mb-2">Filter by Offer:</label>
      <select id="offerFilter" class="block w-full p-2 border border-gray-300 rounded-lg">
        <option value="all">All Offers</option>
      </select>
    </div>

    <!-- Container for dynamically populated tariffs -->
    <div id="tariffs-container" class="space-y-6">
      <!-- Rows for each product/offer will be dynamically inserted here -->
    </div>
  </div>

  <script>
    // Function to fetch and populate data
    async function fetchTariffData() {
      try {
        const response = await fetch('delemont_data_image_parse_1.json');
        const data = await response.json();
        
        const tariffsContainer = document.getElementById('tariffs-container');
        const productFilter = document.getElementById('productFilter');
        const offerFilter = document.getElementById('offerFilter');

        // Populate product filter options
        const products = [...new Set(data.offers.map(offer => offer.name))];
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productFilter.appendChild(option);
        });

        // Populate offer filter options
        const offers = [...new Set(data.offers.map(offer => offer.offer))];
        offers.forEach(offerType => {
          const option = document.createElement('option');
          option.value = offerType;
          option.textContent = offerType;
          offerFilter.appendChild(option);
        });

        // Render function for displaying cards
        function renderOffers(filteredData) {
          tariffsContainer.innerHTML = ''; // Clear previous content
          
          filteredData.forEach(offer => {
            const row = document.createElement('div');
            row.className = 'bg-white shadow-lg rounded-lg p-6';

            // Create HTML for each product/offer
            row.innerHTML = `
              <div class="flex justify-between items-center">
                <div class="w-2/3">
                  <h2 class="text-xl font-semibold mb-2">${offer.name} - ${offer.offer}</h2>
                  <p class="text-gray-600 mb-4">${offer.description}</p>
                  <div>
                    <h3 class="font-bold text-lg">Tariffs:</h3>
                    <div class="space-y-2">
                      ${offer.tariffs.map(tariff => `
                        <p><span class="font-semibold">${tariff.type.charAt(0).toUpperCase() + tariff.type.slice(1)} Tariff: </span>
                        ${tariff.price} cts/kWh (without VAT), ${tariff.price_with_vat} cts/kWh (with VAT)</p>
                      `).join('')}
                    </div>
                  </div>
                  <div class="mt-4">
                    <h3 class="font-bold text-lg">Schedule:</h3>
                    <p>${offer.schedule.map(s => `
                      ${s.tariff.charAt(0).toUpperCase() + s.tariff.slice(1)} rate from ${s.start}:00 to ${s.end}:00
                    `).join(', ')}</p>
                  </div>
                  ${renderScheduleSquares(offer)}
                </div>
                <div class="w-1/3">
                  <canvas id="chart-${offer.offer}-${offer.name}"></canvas>
                </div>
              </div>
            `;
            
            // Append the row to the container
            tariffsContainer.appendChild(row);

            // Create the chart
            const ctx = document.getElementById(`chart-${offer.offer}-${offer.name}`).getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: offer.tariffs.map(t => t.type),
                datasets: [{
                  label: 'Tariff (cts/kWh)',
                  data: offer.tariffs.map(t => t.price),
                  backgroundColor: ['#3498db', '#e74c3c', '#2ecc71'],
                  borderColor: ['#2980b9', '#c0392b', '#27ae60'],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false // Hide the legend for a cleaner look
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return value + " cts/kWh"; // Add units to y-axis labels
                      }
                    }
                  }
                }
              }
            });
          });
        }

        // Function to render schedule squares
        function renderScheduleSquares(offer) {
          const hours = Array.from({length: 24}, (_, i) => i);
          const squares = hours.map(hour => {
            const slot = offer.schedule.find(s => hour >= s.start && hour < s.end);
            const tariffType = slot ? slot.tariff : 'unknown';
            return `<div class="w-6 h-6 inline-block mr-1 ${getTariffColor(tariffType)}"></div>`;
          });

          return `
            <div class="mt-4">
              <h4 class="font-semibold mb-2">24-Hour Schedule:</h4>
              <div class="flex flex-wrap">
                ${squares.join('')}
              </div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="inline-block w-4 h-4 bg-green-500 mr-1"></span> Low Tariff
                <span class="inline-block w-4 h-4 bg-red-500 ml-4 mr-1"></span> High Tariff
                <span class="inline-block w-4 h-4 bg-blue-500 ml-4 mr-1"></span> Fixed Tariff
              </div>
            </div>
          `;
        }

        // Function to get tariff color
        function getTariffColor(tariffType) {
  switch (tariffType) {
    case 'high':
      return 'bg-red-500';
    case 'low':
      return 'bg-green-500';
    case 'fixed':
      return 'bg-blue-500';
    default:
      return 'bg-green-500'; // Change default to green
  }
}


        // Initial rendering of all offers
        renderOffers(data.offers);

        // Filter by product
        productFilter.addEventListener('change', () => {
          const selectedProduct = productFilter.value;
          const selectedOffer = offerFilter.value;

          const filteredData = data.offers.filter(offer => {
            return (selectedProduct === 'all' || offer.name === selectedProduct) && 
                   (selectedOffer === 'all' || offer.offer === selectedOffer);
          });

          renderOffers(filteredData);
        });

        // Filter by offer
        offerFilter.addEventListener('change', () => {
          const selectedProduct = productFilter.value;
          const selectedOffer = offerFilter.value;

          const filteredData = data.offers.filter(offer => {
            return (selectedProduct === 'all' || offer.name === selectedProduct) && 
                   (selectedOffer === 'all' || offer.offer === selectedOffer);
          });

          renderOffers(filteredData);
        });

      } catch (error) {
        console.error("Error fetching the data:", error);
      }
    }

    // Call the function to fetch and populate data
    fetchTariffData();
  </script>
</body>
</html>